<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhysioNote</title>

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --border:#d1d5db;
      --border-strong:#9ca3af;
      --accent:#06b6d4;
      --accent-soft:rgba(6,182,212,.10);
      --accent-dark:#0f172a;
      --text:#111827;
      --muted:#6b7280;
      --danger:#b91c1c;
      --gold:#f59e0b;
      --shadow:0 10px 30px rgba(15,23,42,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .app-shell{max-width:1200px;margin:0 auto;padding:18px 14px 34px}
    .card{
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      padding:16px 18px;
    }
    .card + .card{margin-top:12px}
    .hidden{display:none!important}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:5px}
    select,input[type="date"],input[type="text"],textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:var(--text);
      font-size:13px;
      padding:9px 10px;
      outline:none;
    }
    select:focus,input:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(6,182,212,.18);
      background:#fff;
    }

    .btn{
      border-radius:999px;border:none;
      padding:9px 14px;
      font-size:12px;font-weight:700;
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      transition:transform .05s ease, filter .12s ease, background .12s ease;
      user-select:none;white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:#ecfeff;box-shadow:0 8px 24px rgba(6,182,212,.28)}
    .btn-primary:hover{filter:brightness(1.03)}
    .btn-ghost{background:#f9fafb;color:var(--accent-dark);border:1px solid var(--border)}
    .btn-ghost:hover{background:#fff}
    .btn-danger{background:#fee2e2;color:var(--danger);border:1px solid #fecaca}
    .btn-gold{background:#fff7ed;color:var(--gold);border:1px solid rgba(245,158,11,.55)}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .topbar{
      display:grid;
      grid-template-columns: minmax(0,1.6fr) minmax(0,1fr) auto;
      gap:12px;align-items:end;
    }
    @media (max-width: 980px){
      .topbar{grid-template-columns:1fr}
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border-radius:999px;padding:7px 12px;
      border:1px solid var(--border);
      background:#f9fafb;color:var(--muted);
      font-size:12px; user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(148,163,184,.9)}
    .dot.on{background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.12)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;
      padding:8px;
      border:1px solid var(--border);
      border-radius:14px;
      background:#f9fafb;
    }
    .tab{
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      user-select:none;
    }
    .tab:hover{background:#ffffff}
    .tab.active{
      background:var(--accent);
      color:#ecfeff;
      border-color:var(--accent);
      box-shadow:0 6px 18px rgba(6,182,212,.24);
    }
    .tab.filled{
      border-color:#22c55e;
      color:#166534;
      background:rgba(34,197,94,.08);
    }
    .tab.active.filled{
      background:linear-gradient(90deg, rgba(6,182,212,1), rgba(34,197,94,.90));
      border-color:transparent;
      color:#ecfeff;
    }

    .panel{
      margin-top:10px;
      border-radius:16px;
      border:1px solid var(--border);
      background:#f9fafb;
      padding:12px 14px;
    }
    .panelHead{
      display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelHead .title{
      font-size:14px;font-weight:800;color:var(--accent-dark);margin:0;
    }
    .meta{font-size:12px;color:var(--muted);line-height:1.35}
    textarea.big{
      border-radius:14px;
      min-height:260px;max-height:420px;
      resize:vertical;
      padding:12px;
      font-size:13px;
      line-height:1.55;
      background:#fff;
    }
    @media (max-width: 900px){ textarea.big{min-height:220px} }

    .footerRow{
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(15,23,42,.10);
    }

    .toast{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(6,182,212,.28);
      background:rgba(6,182,212,.08);
      color:#0f172a;
      font-size:12px;
      line-height:1.35;
    }
    .toast.show{display:block}
  </style>
</head>

<body>
<div class="app-shell">

  <!-- TOP: Patient + Session type/date + Voice controls -->
  <div class="card">
    <div class="topbar">
      <div>
        <label for="patientSelect">Patient ausw√§hlen</label>
        <select id="patientSelect"></select>
        <div class="meta" id="patientMeta" style="margin-top:6px"></div>
      </div>

      <div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end">
          <div style="flex:1;min-width:200px">
            <label for="sessionType">Sitzungstyp</label>
            <select id="sessionType">
              <option value="initial">Erstbefund</option>
              <option value="followup">Folgetermin</option>
            </select>
          </div>
          <div style="flex:1;min-width:200px">
            <label for="sessionDate">Datum</label>
            <input id="sessionDate" type="date" />
          </div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="pill" title="Mikrofonstatus">
          <span class="dot" id="micDot"></span>
          <span id="micText">Mic: OFF</span>
        </div>
        <div class="btnrow">
          <button class="btn btn-primary" id="btnStart">üéôÔ∏è Start</button>
          <button class="btn btn-danger" id="btnStop">Stop</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <!-- Tabs + One panel (true tab UI) -->
  <div class="card">
    <div class="tabs" id="tabs" aria-label="Dokumentations-Tabs">
      <div class="tab active" data-tab="anamnese">Anamnese</div>
      <div class="tab" data-tab="befund">Befund</div>
      <div class="tab" data-tab="diagnose">Diagnose</div>
      <div class="tab" data-tab="therapieplan">Therapieplan</div>
      <div class="tab" data-tab="verlauf">Verlauf</div>
      <div class="tab" data-tab="epikrise">Epikrise</div>
      <div class="tab" data-tab="notizen">Notizen</div>
    </div>

    <div class="panel">
      <div class="panelHead">
        <div>
          <div class="title" id="panelTitle">Anamnese</div>
          <div class="meta" id="panelMeta">Vorgeschichte, Alltag, Verlauf, bisherige Behandlungen.</div>
        </div>
        <div class="pill">
          <span>Aktiv:</span> <span class="mono" id="activeFieldLabel">‚Äî</span>
        </div>
      </div>

      <!-- exactly ONE textarea visible at a time (tabbed) -->
      <textarea id="taAnamnese" class="big" placeholder="‚Äû√ñffne Anamnese‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>
      <textarea id="taBefund" class="big hidden" placeholder="‚Äû√ñffne Befund‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>
      <textarea id="taDiagnose" class="big hidden" placeholder="‚Äû√ñffne Diagnose‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>
      <textarea id="taTherapieplan" class="big hidden" placeholder="‚Äû√ñffne Therapieplan‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>
      <textarea id="taVerlauf" class="big hidden" placeholder="‚Äû√ñffne Verlauf‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>
      <textarea id="taEpikrise" class="big hidden" placeholder="‚Äû√ñffne Epikrise‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>
      <textarea id="taNotizen" class="big hidden" placeholder="‚Äû√ñffne Notizen‚Äú ‚Üí sprechen ‚Üí ‚ÄûSchlie√üe Feld‚Äú"></textarea>

      <div class="footerRow">
        <div class="btnrow">
          <button class="btn btn-ghost" id="btnCloseField">‚úñÔ∏è Schlie√üe Feld</button>
          <button class="btn btn-ghost" id="btnFieldClear">üßΩ Feld leeren</button>
          <button class="btn btn-ghost" id="btnClear">üßº Alles leeren</button>
        </div>

        <div class="btnrow">
          <button class="btn btn-ghost" id="btnSave">‚úÖ An THEORG senden</button>
          <button class="btn btn-gold" id="btnPdf">üìÑ PDF generieren</button>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  // ===== UTIL =====
  const $ = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tz = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tz*60000);
    return local.toISOString().slice(0,10);
  }

  function normalize(s){
    return (s||"")
      .toLowerCase()
      .replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/√ü/g,"ss")
      .replace(/[^\p{L}\p{N}\s]/gu," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>t.classList.remove("show"), 2400);
  }

  // ===== PATIENT MOCK (replace later) =====
  const patients = [
    { id:"thg-1001", name:"Max Muster", year:1987, note:"Knie / Erstkontakt" },
    { id:"thg-1002", name:"Laura Beispiel", year:1994, note:"R√ºcken / Verlauf" },
    { id:"thg-1003", name:"Tim Demo", year:1979, note:"Schulter / Post-OP" },
    { id:"thg-1004", name:"Sara Test", year:1990, note:"Nacken / Stress" },
  ];

  function renderPatients(){
    const sel = $("patientSelect");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî Patient ausw√§hlen ‚Äî";
    sel.appendChild(opt0);
    for(const p of patients){
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = `${p.name} (${p.year})`;
      sel.appendChild(o);
    }
  }

  function updatePatientMeta(){
    const id = $("patientSelect").value;
    const p = patients.find(x => x.id === id);
    $("patientMeta").textContent = p ? `THEORG-ID: ${p.id} ¬∑ ${p.note}` : "";
  }

  // ===== TABS / FIELDS =====
  const tabMeta = {
    anamnese: "Vorgeschichte, Alltag, Verlauf, bisherige Behandlungen.",
    befund: "Status: Schmerz, ROM, Kraft, Funktion, Tests, Palpation.",
    diagnose: "Physiotherapeutische Einsch√§tzung / Hypothese / Relevantes.",
    therapieplan: "Ziele, Ma√ünahmen, Frequenz, Heim√ºbungen.",
    verlauf: "Reaktion auf Therapie, Ver√§nderungen, Anpassungen.",
    epikrise: "Zusammenfassung, Empfehlung, next steps.",
    notizen: "Freie Notizen."
  };

  const textareas = {
    anamnese: $("taAnamnese"),
    befund: $("taBefund"),
    diagnose: $("taDiagnose"),
    therapieplan: $("taTherapieplan"),
    verlauf: $("taVerlauf"),
    epikrise: $("taEpikrise"),
    notizen: $("taNotizen")
  };

  function tabLabel(k){
    return ({
      anamnese:"Anamnese",
      befund:"Befund",
      diagnose:"Diagnose",
      therapieplan:"Therapieplan",
      verlauf:"Verlauf",
      epikrise:"Epikrise",
      notizen:"Notizen"
    })[k] || k;
  }

  let activeTab = "anamnese";
  let fieldOpen = false;

  function updateFilledTabs(){
    document.querySelectorAll(".tab").forEach(el=>{
      const k = el.dataset.tab;
      const has = (textareas[k].value || "").trim().length > 0;
      el.classList.toggle("filled", has);
    });
  }

  function setActiveTab(tab){
    activeTab = tab;

    document.querySelectorAll(".tab").forEach(el=>{
      el.classList.toggle("active", el.dataset.tab === tab);
    });

    Object.entries(textareas).forEach(([k, ta])=>{
      ta.classList.toggle("hidden", k !== tab);
    });

    $("panelTitle").textContent = tabLabel(tab);
    $("panelMeta").textContent = tabMeta[tab] || "";
    $("activeFieldLabel").textContent = fieldOpen ? tabLabel(tab) : "‚Äî";

    if(fieldOpen){
      textareas[tab].focus();
      textareas[tab].scrollTop = textareas[tab].scrollHeight;
    }

    updateFilledTabs();
  }

  function openField(tab){
    fieldOpen = true;
    setActiveTab(tab);
    $("activeFieldLabel").textContent = tabLabel(tab);
    showToast(`√ñffne ${tabLabel(tab)}`);
  }

  function closeField(){
    fieldOpen = false;
    $("activeFieldLabel").textContent = "‚Äî";
    showToast("Feld geschlossen");
  }

  function clearField(){
    textareas[activeTab].value = "";
    updateFilledTabs();
    showToast(`${tabLabel(activeTab)} geleert`);
  }

  function clearAll(){
    Object.values(textareas).forEach(ta => ta.value = "");
    updateFilledTabs();
    closeField();
    showToast("Alles geleert");
  }

  $("tabs").addEventListener("click", (e)=>{
    const el = e.target.closest(".tab");
    if(!el) return;
    setActiveTab(el.dataset.tab);
  });

  Object.values(textareas).forEach(ta => ta.addEventListener("input", updateFilledTabs));

  // ===== VOICE =====
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let listening = false;

  function setMic(on){
    listening = on;
    $("micDot").classList.toggle("on", on);
    $("micText").textContent = on ? "Mic: ON" : "Mic: OFF";
  }

  function startListening(){
    if(!SpeechRecognition){
      showToast("SpeechRecognition nicht verf√ºgbar (Chrome/Edge).");
      return;
    }
    if(listening) return;

    rec = new SpeechRecognition();
    rec.lang = "de-DE";
    rec.interimResults = true;
    rec.continuous = true;

    rec.onstart = () => {
      setMic(true);
      showToast("Listening ON");
    };

    rec.onerror = () => {
      setMic(false);
      showToast("Mikrofon-Fehler");
    };

    rec.onend = () => {
      setMic(false);
    };

    rec.onresult = (event) => {
      for(let i=event.resultIndex;i<event.results.length;i++){
        const res = event.results[i];
        const raw = (res[0] && res[0].transcript ? res[0].transcript : "").trim();
        if(!raw) continue;

        const t = normalize(raw);

        // Commands
        const mOpen = t.match(/^oeffne\s+(anamnese|befund|diagnose|therapieplan|therapie plan|verlauf|epikrise|notizen|notiz)\b/);
        if(mOpen){
          const v = mOpen[1];
          const key =
            v === "anamnese" ? "anamnese" :
            v === "befund" ? "befund" :
            v === "diagnose" ? "diagnose" :
            (v === "therapieplan" || v === "therapie plan") ? "therapieplan" :
            v === "verlauf" ? "verlauf" :
            v === "epikrise" ? "epikrise" :
            (v === "notizen" || v === "notiz") ? "notizen" : "anamnese";
          openField(key);
          continue;
        }

        if(t === "schliesse feld" || t === "feld schliessen" || t === "schliesse" || t === "schlie√üe feld"){
          closeField();
          continue;
        }

        if(t === "alles leeren" || t === "reset"){
          clearAll();
          continue;
        }

        if(t === "feld leeren" || t === "leeren"){
          clearField();
          continue;
        }

        if(t === "pdf" || t === "pdf generieren" || t === "export pdf"){
          exportPdf();
          continue;
        }

        if(t === "stop" || t === "stopp"){
          stopListening();
          continue;
        }

        // Dictation (only if field open)
        if(!fieldOpen) continue;

        if(res.isFinal){
          const cur = (textareas[activeTab].value || "").trim();
          const next = (cur ? (cur + " ") : "") + raw.trim();
          textareas[activeTab].value = next;
          textareas[activeTab].scrollTop = textareas[activeTab].scrollHeight;
          updateFilledTabs();
        }
      }
    };

    try{ rec.start(); } catch(e){ showToast("Start fehlgeschlagen"); }
  }

  function stopListening(){
    if(rec){
      try{ rec.stop(); } catch(e){}
    }
    rec = null;
    setMic(false);
    showToast("Listening OFF");
  }

  // ===== THEORG MOCK SAVE =====
  function buildPayload(){
    const pid = $("patientSelect").value;
    const p = patients.find(x => x.id === pid) || null;

    return {
      integration: "THEORG",
      patient: p ? { id:p.id, name:p.name, year:p.year } : null,
      session: {
        type: $("sessionType").value,
        date: $("sessionDate").value || null,
        fields: {
          anamnese: textareas.anamnese.value.trim(),
          befund: textareas.befund.value.trim(),
          diagnose: textareas.diagnose.value.trim(),
          therapieplan: textareas.therapieplan.value.trim(),
          verlauf: textareas.verlauf.value.trim(),
          epikrise: textareas.epikrise.value.trim(),
          notizen: textareas.notizen.value.trim()
        }
      },
      createdAt: new Date().toISOString()
    };
  }

  function sendToTHEORG(){
    const payload = buildPayload();
    if(!payload.patient){
      showToast("Bitte Patient ausw√§hlen");
      return;
    }
    console.log("THEORG payload (mock):", payload);
    showToast("An THEORG gesendet (Mock)");
  }

  // ===== PDF =====
  function exportPdf(){
    const payload = buildPayload();
    const now = new Date().toLocaleString("de-DE");
    const esc = (s) => (s||"")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/\n/g,"<br/>");

    const patientLine = payload.patient
      ? `${payload.patient.name} (${payload.patient.year}) ¬∑ ${payload.patient.id}`
      : "‚Äî";

    const blocks = [
      ["Anamnese", payload.session.fields.anamnese],
      ["Befund", payload.session.fields.befund],
      ["Diagnose", payload.session.fields.diagnose],
      ["Therapieplan", payload.session.fields.therapieplan],
      ["Verlauf", payload.session.fields.verlauf],
      ["Epikrise", payload.session.fields.epikrise],
      ["Notizen", payload.session.fields.notizen],
    ].map(([h,v]) => `
      <h2>${h}</h2>
      <div class="box">${esc(v && v.trim() ? v : "‚Äî")}</div>
    `).join("");

    const w = window.open("", "_blank");
    w.document.open();
    w.document.write(`
      <!doctype html><html><head>
      <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
      <title>PhysioNote ‚Äì PDF</title>
      <style>
        body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;padding:26px;color:#111827}
        h1{margin:0;font-size:20px;color:#0f172a}
        .meta{margin-top:6px;color:#6b7280;font-size:12px}
        h2{font-size:14px;margin:18px 0 8px 0;color:#0f172a}
        .box{border:1px solid #d1d5db;border-radius:12px;padding:12px;background:#f9fafb;line-height:1.55}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
        .k{color:#6b7280;font-size:12px}
        .v{font-size:12px}
        @media (max-width:700px){.grid{grid-template-columns:1fr}}
      </style>
      </head><body>
        <h1>Dokumentation</h1>
        <div class="meta">PhysioNote ¬∑ ${now}</div>
        <div class="grid">
          <div><div class="k">Patient</div><div class="v">${esc(patientLine)}</div></div>
          <div><div class="k">Sitzung</div><div class="v">${esc(payload.session.type)} ¬∑ ${esc(payload.session.date || "‚Äî")}</div></div>
        </div>
        ${blocks}
        <script>window.onload=()=>window.print();<\/script>
      </body></html>
    `);
    w.document.close();
    showToast("PDF ge√∂ffnet");
  }

  // ===== WIRE UI =====
  $("btnStart").addEventListener("click", startListening);
  $("btnStop").addEventListener("click", stopListening);
  $("btnCloseField").addEventListener("click", closeField);
  $("btnFieldClear").addEventListener("click", clearField);
  $("btnClear").addEventListener("click", clearAll);
  $("btnSave").addEventListener("click", sendToTHEORG);
  $("btnPdf").addEventListener("click", exportPdf);
  $("patientSelect").addEventListener("change", updatePatientMeta);

  // keyboard shortcuts (optional but nice)
  document.addEventListener("keydown", (e)=>{
    if(e.code === "Space"){
      e.preventDefault();
      listening ? stopListening() : startListening();
    }
    if(e.code === "Escape"){
      e.preventDefault();
      closeField();
    }
  });

  // ===== INIT =====
  renderPatients();
  updatePatientMeta();
  $("sessionDate").value = todayISO();
  setActiveTab("anamnese");
  closeField();
</script>
</body>
</html>