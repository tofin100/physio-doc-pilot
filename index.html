<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhysioNote</title>

  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --border:#d1d5db;
      --border-strong:#9ca3af;
      --accent:#06b6d4;
      --accent-soft:rgba(6,182,212,.10);
      --accent-dark:#0f172a;
      --text:#111827;
      --muted:#6b7280;
      --danger:#b91c1c;
      --gold:#f59e0b;
      --gold-soft:rgba(245,158,11,.10);
      --shadow:0 10px 30px rgba(15,23,42,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg); color:var(--text);
    }
    .app-shell{max-width:1200px;margin:0 auto;padding:22px 14px 36px}
    .card{
      border-radius:var(--radius);
      border:1px solid var(--border);
      background:var(--card);
      box-shadow:var(--shadow);
      padding:18px 20px;
    }
    .card + .card{margin-top:14px}
    .hidden{display:none!important}

    /* Header */
    .hero{position:relative; overflow:hidden; padding:18px 20px}
    .hero::before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 15% 0%, rgba(6,182,212,.22), transparent 55%),
        radial-gradient(circle at 85% 10%, rgba(15,23,42,.09), transparent 60%);
      pointer-events:none;
    }
    .hero-inner{
      position:relative; z-index:1;
      display:flex; justify-content:space-between; align-items:center;
      gap:12px; flex-wrap:wrap;
    }
    .brand h1{margin:0;font-size:28px;font-weight:900;letter-spacing:-.03em;color:var(--accent-dark)}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border-radius:999px;padding:7px 12px;
      border:1px solid var(--border);
      background:#f9fafb;color:var(--muted);
      font-size:12px; user-select:none;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(148,163,184,.9)}
    .dot.on{background:#22c55e; box-shadow:0 0 0 4px rgba(34,197,94,.12)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    /* Controls */
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:5px}
    select, input[type="date"], input[type="text"], textarea{
      width:100%;
      border-radius:12px;
      border:1px solid var(--border);
      background:#f9fafb;
      color:var(--text);
      font-size:13px;
      padding:9px 10px;
      outline:none;
    }
    select:focus, input:focus, textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(6,182,212,.18);
      background:#fff;
    }

    .top-grid{
      display:grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 1fr);
      gap:14px;
      align-items:end;
    }
    @media (max-width: 900px){
      .top-grid{grid-template-columns:1fr}
    }

    .btn{
      border-radius:999px;
      border:none;
      padding:9px 14px;
      font-size:12px;
      font-weight:800;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:transform .05s ease, filter .12s ease, background .12s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:#ecfeff;box-shadow:0 8px 24px rgba(6,182,212,.30)}
    .btn-primary:hover{filter:brightness(1.03)}
    .btn-ghost{background:#f9fafb;color:var(--accent-dark);border:1px solid var(--border)}
    .btn-ghost:hover{background:#fff}
    .btn-gold{
      background:#fff7ed;color:var(--gold);
      border:1px solid rgba(245,158,11,.55);
      box-shadow:0 0 0 1px var(--gold-soft);
    }
    .btn-danger{background:#fee2e2;color:var(--danger);border:1px solid #fecaca}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btnrow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end}

    .status{
      margin-top:12px;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(15,23,42,.10);
      background:#f9fafb;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      word-break:break-word;
    }
    .kbd{
      font-size:11px;
      padding:2px 6px;
      border-radius:6px;
      border:1px solid rgba(15,23,42,.15);
      background:#fff;
      color:#0f172a;
    }

    /* Session / Tabs */
    .section-title{margin:0 0 10px 0;font-size:14px;font-weight:800;color:var(--accent-dark)}
    .grid-session-head{
      display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; justify-content:space-between;
      margin-bottom:10px;
    }
    .grid-session-head .left{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .field{min-width:210px}
    @media (max-width: 700px){ .field{min-width: 100%} }

    .tabs{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 10px}
    .tab{
      border-radius:999px;
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      border:1px solid var(--border);
      background:#f9fafb;
      color:var(--muted);
      user-select:none;
    }
    .tab.active{
      background:var(--accent);
      color:#ecfeff;
      border-color:var(--accent);
      box-shadow:0 6px 18px rgba(6,182,212,.28);
    }
    .tab.filled{
      border-color:#22c55e;
      color:#166534;
      box-shadow:0 0 0 1px rgba(34,197,94,.28);
    }

    .panel{
      border-radius:14px;
      border:1px solid var(--border);
      background:#f9fafb;
      padding:12px 14px;
    }
    .panelHead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;
      flex-wrap:wrap;
    }
    .panelHead strong{font-size:13px;color:var(--accent-dark)}
    .meta{font-size:12px;color:var(--muted);line-height:1.35}
    textarea.big{
      border-radius:14px;
      min-height:260px;
      max-height:420px;
      resize:vertical;
      padding:12px 12px;
      font-size:13px;
      line-height:1.55;
    }
    @media (max-width: 900px){ textarea.big{min-height:220px} }

    .footerRow{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .hint{font-size:12px;color:var(--muted);line-height:1.45;margin-top:8px}
    .toast{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(6,182,212,.28);
      background:rgba(6,182,212,.08);
      color:#0f172a;
      font-size:12px;
      line-height:1.45;
    }
    .toast.show{display:block}

    /* Bottom actions */
    .actions-bottom{
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid rgba(15,23,42,.08);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
  </style>
</head>

<body>
<div class="app-shell">

  <!-- HEADER (nur Titel + Listening oben) -->
  <div class="card hero">
    <div class="hero-inner">
      <div class="brand">
        <h1>PhysioNote</h1>
      </div>

      <div class="right">
        <button class="btn btn-primary" id="btnStart">üéôÔ∏è Start Listening</button>
        <button class="btn btn-danger" id="btnStop">‚èπÔ∏è Stop</button>

        <div class="pill" title="Mikrofonstatus">
          <span class="dot" id="micDot"></span>
          <span id="micText">Mic: OFF</span>
        </div>
        <div class="pill" title="Aktives Feld">
          <span>Active:</span>
          <span class="mono" id="activeFieldLabel">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="status" id="status">
      Status: Bereit. Du kannst alles per Sprache steuern.
      <div style="margin-top:6px">
        Beispiele:
        <span class="kbd">‚Äû√ñffne Anamnese‚Äú</span>
        <span class="kbd">‚ÄûW√§hle Patient Max Muster‚Äú</span>
        <span class="kbd">‚ÄûSitzung Erstbefund‚Äú</span>
        <span class="kbd">‚ÄûDatum heute‚Äú</span>
        <span class="kbd">‚ÄûSchlie√üe Feld‚Äú</span>
        <span class="kbd">‚ÄûPDF‚Äú</span>
      </div>
      <div style="margin-top:6px">
        Shortcuts: <span class="kbd">Space</span> Start/Stop ¬∑ <span class="kbd">Esc</span> Schlie√üe Feld
      </div>
    </div>
  </div>

  <!-- PATIENT + SESSION (direkt unter Titel) -->
  <div class="card">
    <div class="top-grid">
      <div>
        <label for="patientSelect">Patient ausw√§hlen</label>
        <select id="patientSelect"></select>
        <div class="hint" id="patientMeta"></div>
      </div>

      <div>
        <div class="row" style="gap:12px">
          <div class="field" style="min-width:210px;flex:1">
            <label for="sessionType">Sitzungstyp</label>
            <select id="sessionType">
              <option value="initial">Erstbefund</option>
              <option value="followup">Folgetermin</option>
            </select>
          </div>

          <div class="field" style="min-width:210px;flex:1">
            <label for="sessionDate">Datum</label>
            <input id="sessionDate" type="date" />
          </div>
        </div>

        <div class="toast" id="toast"></div>

        <div class="hint">
          Voice-Befehle (Auswahl):
          <span class="kbd">‚ÄûW√§hle Patient ‚Ä¶‚Äú</span>
          <span class="kbd">‚ÄûN√§chster Patient‚Äú</span>
          <span class="kbd">‚ÄûVorheriger Patient‚Äú</span>
          <span class="kbd">‚ÄûSitzung Erstbefund‚Äú</span>
          <span class="kbd">‚ÄûSitzung Folgetermin‚Äú</span>
          <span class="kbd">‚ÄûDatum heute/gestern/morgen‚Äú</span>
          <span class="kbd">‚Äû√ñffne Befund‚Äú</span>
          <span class="kbd">‚ÄûSchlie√üe Feld‚Äú</span>
        </div>
      </div>
    </div>
  </div>

  <!-- SESSION + TABS (unten perfekt: bleibt) -->
  <div class="card">
    <h3 class="section-title">Dokumentation</h3>

    <!-- Tabs -->
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="anamnese">Anamnese</div>
      <div class="tab" data-tab="befund">Befund</div>
      <div class="tab" data-tab="diagnose">Diagnose</div>
      <div class="tab" data-tab="therapieplan">Therapieplan</div>
      <div class="tab" data-tab="verlauf">Verlauf</div>
      <div class="tab" data-tab="epikrise">Epikrise</div>
      <div class="tab" data-tab="notizen">Notizen</div>
    </div>

    <!-- Panel -->
    <div class="panel">
      <div class="panelHead">
        <div>
          <strong id="panelTitle">Anamnese</strong>
          <div class="meta" id="panelMeta">Vorgeschichte, Alltag, Verlauf, bisherige Behandlungen.</div>
        </div>
        <div class="pill">
          <span>Target:</span> <span class="mono" id="panelTarget">anamnese</span>
        </div>
      </div>

      <textarea id="taAnamnese" class="big" placeholder="Sage: ‚Äû√ñffne Anamnese‚Äú ‚Äì dann wird hier transkribiert."></textarea>
      <textarea id="taBefund" class="big hidden" placeholder="Sage: ‚Äû√ñffne Befund‚Äú ‚Äì dann wird hier transkribiert."></textarea>
      <textarea id="taDiagnose" class="big hidden" placeholder="Sage: ‚Äû√ñffne Diagnose‚Äú ‚Äì dann wird hier transkribiert."></textarea>
      <textarea id="taTherapieplan" class="big hidden" placeholder="Sage: ‚Äû√ñffne Therapieplan‚Äú ‚Äì dann wird hier transkribiert."></textarea>
      <textarea id="taVerlauf" class="big hidden" placeholder="Sage: ‚Äû√ñffne Verlauf‚Äú ‚Äì dann wird hier transkribiert."></textarea>
      <textarea id="taEpikrise" class="big hidden" placeholder="Sage: ‚Äû√ñffne Epikrise‚Äú ‚Äì dann wird hier transkribiert."></textarea>
      <textarea id="taNotizen" class="big hidden" placeholder="Sage: ‚Äû√ñffne Notizen‚Äú ‚Äì dann wird hier transkribiert."></textarea>

      <div class="footerRow">
        <div class="meta">
          Tipp: Wenn kein Feld offen ist, wird nichts geschrieben. Das verhindert ‚ÄúDurcheinander‚Äù.
        </div>
        <div class="btnrow">
          <button class="btn btn-ghost" id="btnCloseField">‚úñÔ∏è Schlie√üe Feld</button>
          <button class="btn btn-ghost" id="btnFieldClear">üßΩ Feld leeren</button>
        </div>
      </div>
    </div>

    <!-- BOTTOM ACTIONS (alles ganz nach unten) -->
    <div class="actions-bottom">
      <div class="meta">
        Aktionen:
        <span class="mono">‚ÄûPDF‚Äú</span> ¬∑ <span class="mono">‚ÄûSpeichern‚Äú</span> ¬∑ <span class="mono">‚ÄûKopieren‚Äú</span> ¬∑ <span class="mono">‚ÄûAlles leeren‚Äú</span>
      </div>
      <div class="btnrow">
        <button class="btn btn-ghost" id="btnCopy">üìã Kopieren (Feld)</button>
        <button class="btn btn-ghost" id="btnClear">üßº Alles leeren</button>
        <button class="btn btn-gold" id="btnPdf">üìÑ PDF generieren</button>
        <button class="btn btn-primary" id="btnSave">‚úÖ An THEORG senden</button>
      </div>
    </div>
  </div>

</div>

<script>
  // ---------- UTIL ----------
  const $ = (id) => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    const tz = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tz*60000);
    return local.toISOString().slice(0,10);
  }

  function shiftISO(days){
    const d = new Date();
    d.setDate(d.getDate() + days);
    const tz = d.getTimezoneOffset();
    const local = new Date(d.getTime() - tz*60000);
    return local.toISOString().slice(0,10);
  }

  function normalize(s){
    return (s||"")
      .toLowerCase()
      .replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/√ü/g,"ss")
      .replace(/[^\p{L}\p{N}\s]/gu," ")
      .replace(/\s+/g," ")
      .trim();
  }

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(showToast._tm);
    showToast._tm = setTimeout(()=>t.classList.remove("show"), 2600);
  }

  function setStatus(html){
    $("status").innerHTML = "Status: " + html;
  }

  function persist(){
    try{
      const payload = {
        patientId: $("patientSelect").value || "",
        sessionType: $("sessionType").value || "initial",
        sessionDate: $("sessionDate").value || "",
        fields: {
          anamnese: textareas.anamnese.value,
          befund: textareas.befund.value,
          diagnose: textareas.diagnose.value,
          therapieplan: textareas.therapieplan.value,
          verlauf: textareas.verlauf.value,
          epikrise: textareas.epikrise.value,
          notizen: textareas.notizen.value,
        },
        activeTab
      };
      localStorage.setItem("physionote_state_v1", JSON.stringify(payload));
    }catch(e){}
  }

  function restore(){
    try{
      const raw = localStorage.getItem("physionote_state_v1");
      if(!raw) return;
      const s = JSON.parse(raw);
      if(s.sessionType) $("sessionType").value = s.sessionType;
      if(s.sessionDate) $("sessionDate").value = s.sessionDate;
      if(s.patientId) $("patientSelect").value = s.patientId;
      if(s.fields){
        for(const k of Object.keys(textareas)){
          if(typeof s.fields[k] === "string") textareas[k].value = s.fields[k];
        }
      }
      updatePatientMeta();
      updateFilledTabs();
      if(s.activeTab) setActiveTab(s.activeTab);
    }catch(e){}
  }

  // ---------- PATIENT MOCK (replace later via THEORG adapter) ----------
  const patients = [
    { id:"thg-1001", name:"Max Muster", year:1987, note:"Erstkontakt / Knie" },
    { id:"thg-1002", name:"Laura Beispiel", year:1994, note:"R√ºcken / Verlauf" },
    { id:"thg-1003", name:"Tim Demo", year:1979, note:"Schulter / Post-OP" },
    { id:"thg-1004", name:"Sara Test", year:1990, note:"Nacken / Stress" },
  ];

  function renderPatients(){
    const sel = $("patientSelect");
    sel.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = "‚Äî Patient ausw√§hlen ‚Äî";
    sel.appendChild(opt0);

    for(const p of patients){
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = `${p.name} (${p.year})`;
      sel.appendChild(o);
    }
  }

  function getSelectedPatientIndex(){
    const id = $("patientSelect").value;
    return patients.findIndex(p => p.id === id);
  }

  function updatePatientMeta(){
    const sel = $("patientSelect");
    const p = patients.find(x => x.id === sel.value);
    $("patientMeta").textContent = p
      ? `THEORG-ID: ${p.id} ¬∑ ${p.note || ""}`.trim()
      : "W√§hle einen Patienten aus THEORG (Mock).";
    persist();
  }

  function selectPatientByIndex(idx){
    if(idx < 0 || idx >= patients.length) return false;
    $("patientSelect").value = patients[idx].id;
    updatePatientMeta();
    showToast(`Patient: ${patients[idx].name}`);
    setStatus(`Patient gesetzt: <b>${patients[idx].name}</b>`);
    return true;
  }

  function findPatientByName(query){
    const q = normalize(query);
    if(!q) return null;

    // match: full name includes query (for ‚Äúmax‚Äù, ‚Äúmax muster‚Äù, etc.)
    const hits = patients
      .map((p, i) => ({ p, i, n: normalize(p.name) }))
      .filter(x => x.n.includes(q));

    if(hits.length === 1) return hits[0];
    if(hits.length > 1){
      // prefer startsWith
      const starts = hits.find(x => x.n.startsWith(q));
      return starts || hits[0];
    }
    return null;
  }

  // ---------- TABS ----------
  const tabMeta = {
    anamnese: "Vorgeschichte, Alltag, Verlauf, bisherige Behandlungen.",
    befund: "Status: Schmerz, ROM, Kraft, Funktion, Tests, Palpation.",
    diagnose: "Physiotherapeutische Einsch√§tzung / Hypothese / Relevantes.",
    therapieplan: "Ziele, Ma√ünahmen, Frequenz, Heim√ºbungen.",
    verlauf: "Reaktion auf Therapie, Ver√§nderungen, Anpassungen.",
    epikrise: "Zusammenfassung, Empfehlung, next steps.",
    notizen: "Freie Notizen (z.B. Kommunikation, Besonderheiten)."
  };

  const textareas = {
    anamnese: $("taAnamnese"),
    befund: $("taBefund"),
    diagnose: $("taDiagnose"),
    therapieplan: $("taTherapieplan"),
    verlauf: $("taVerlauf"),
    epikrise: $("taEpikrise"),
    notizen: $("taNotizen")
  };

  let activeTab = "anamnese";
  let activeFieldOpen = false;

  function tabLabel(tab){
    const map = {
      anamnese:"Anamnese",
      befund:"Befund",
      diagnose:"Diagnose",
      therapieplan:"Therapieplan",
      verlauf:"Verlauf",
      epikrise:"Epikrise",
      notizen:"Notizen"
    };
    return map[tab] || tab;
  }

  function updateFilledTabs(){
    document.querySelectorAll(".tab").forEach(el => {
      const k = el.dataset.tab;
      const has = (textareas[k].value || "").trim().length > 0;
      el.classList.toggle("filled", has);
    });
  }

  function setActiveTab(tab){
    activeTab = tab;

    document.querySelectorAll(".tab").forEach(el => {
      el.classList.toggle("active", el.dataset.tab === tab);
    });

    Object.entries(textareas).forEach(([k, ta]) => {
      ta.classList.toggle("hidden", k !== tab);
    });

    $("panelTitle").textContent = tabLabel(tab);
    $("panelMeta").textContent = tabMeta[tab] || "";
    $("panelTarget").textContent = tab;

    updateFilledTabs();

    if(activeFieldOpen){
      textareas[tab].focus();
      textareas[tab].scrollTop = textareas[tab].scrollHeight;
    }

    $("activeFieldLabel").textContent = activeFieldOpen ? tab : "‚Äî";
    persist();
  }

  function openField(tab){
    activeFieldOpen = true;
    setActiveTab(tab);
    $("activeFieldLabel").textContent = tab;
    setStatus(`<b>Aktives Feld:</b> ${tabLabel(tab)} ¬∑ Sprich jetzt.`);
    showToast(`Feld ge√∂ffnet: ${tabLabel(tab)}`);
  }

  function closeField(){
    activeFieldOpen = false;
    $("activeFieldLabel").textContent = "‚Äî";
    setStatus(`Feld geschlossen. Sag <span class="mono">‚Äû√ñffne ‚Ä¶‚Äú</span> um zu diktieren.`);
    showToast("Feld geschlossen");
  }

  function clearActiveField(){
    textareas[activeTab].value = "";
    updateFilledTabs();
    persist();
    showToast(`${tabLabel(activeTab)} geleert`);
  }

  function clearAll(){
    Object.values(textareas).forEach(ta => ta.value = "");
    updateFilledTabs();
    closeField();
    persist();
    showToast("Alles geleert");
  }

  $("tabs").addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    setActiveTab(t.dataset.tab);
  });

  Object.values(textareas).forEach(ta => ta.addEventListener("input", ()=>{
    updateFilledTabs();
    persist();
  }));

  // ---------- VOICE (Web Speech API) ----------
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let rec = null;
  let listening = false;

  function setMic(on){
    listening = on;
    $("micDot").classList.toggle("on", on);
    $("micText").textContent = on ? "Mic: ON" : "Mic: OFF";
  }

  function supportsSpeech(){
    return !!SpeechRecognition;
  }

  function startListening(){
    if(!supportsSpeech()){
      setStatus(`‚ö†Ô∏è SpeechRecognition nicht verf√ºgbar. Bitte Chrome/Edge verwenden.`);
      showToast("SpeechRecognition nicht verf√ºgbar");
      return;
    }
    if(listening) return;

    rec = new SpeechRecognition();
    rec.lang = "de-DE";
    rec.interimResults = true;
    rec.continuous = true;

    rec.onstart = () => {
      setMic(true);
      setStatus(`Listening ON. Sprich Kommandos oder √∂ffne ein Feld zum Diktieren.`);
      showToast("Listening ON");
    };

    rec.onerror = (e) => {
      setMic(false);
      setStatus(`‚ö†Ô∏è Mikrofon-Fehler: <span class="mono">${e && e.error ? e.error : "unbekannt"}</span>`);
      showToast("Mikrofon-Fehler");
    };

    rec.onend = () => {
      setMic(false);
      setStatus(`Listening OFF.`);
    };

    rec.onresult = (event) => {
      for(let i = event.resultIndex; i < event.results.length; i++){
        const res = event.results[i];
        const transcript = (res[0] && res[0].transcript ? res[0].transcript : "").trim();
        if(!transcript) continue;

        const t = normalize(transcript);

        // ---------- COMMANDS (immer) ----------
        // Open tab/field
        const mOpen = t.match(/^oeffne\s+(anamnese|befund|diagnose|therapieplan|therapie plan|verlauf|epikrise|notizen|notiz)\b/);
        if(mOpen){
          const v = mOpen[1];
          const key =
            v === "anamnese" ? "anamnese" :
            v === "befund" ? "befund" :
            v === "diagnose" ? "diagnose" :
            (v === "therapieplan" || v === "therapie plan") ? "therapieplan" :
            v === "verlauf" ? "verlauf" :
            v === "epikrise" ? "epikrise" :
            (v === "notizen" || v === "notiz") ? "notizen" : "anamnese";
          openField(key);
          continue;
        }

        // Close field
        if(t === "schliesse feld" || t === "feld schliessen" || t === "schliesse" || t === "schliesse das feld" || t === "schlie√üe feld"){
          closeField();
          continue;
        }

        // Patient selection
        // ‚ÄúW√§hle Patient Max Muster‚Äù / ‚ÄúPatient Max Muster‚Äù
        let mPatient = t.match(/^(waehle\s+)?patient\s+(.+)$/);
        if(mPatient){
          const q = mPatient[2];
          const hit = findPatientByName(q);
          if(hit){
            selectPatientByIndex(hit.i);
          } else {
            showToast("Patient nicht gefunden");
            setStatus(`‚ö†Ô∏è Patient nicht gefunden. Sag z.B. <span class="mono">‚ÄûW√§hle Patient Max Muster‚Äú</span>.`);
          }
          continue;
        }
        if(t === "naechster patient" || t === "naechste patientin" || t === "naechster"){
          const idx = getSelectedPatientIndex();
          const next = (idx < 0) ? 0 : Math.min(patients.length-1, idx+1);
          selectPatientByIndex(next);
          continue;
        }
        if(t === "vorheriger patient" || t === "vorherige patientin" || t === "zurueck patient" || t === "vorheriger"){
          const idx = getSelectedPatientIndex();
          const prev = (idx <= 0) ? 0 : idx-1;
          selectPatientByIndex(prev);
          continue;
        }

        // Session type
        // ‚ÄúSitzung Erstbefund‚Äù / ‚ÄúSitzung Folgetermin‚Äù
        const mSession = t.match(/^sitzung\s+(erstbefund|folgetermin|folge termin|followup|initial)\b/);
        if(mSession){
          const v = mSession[1];
          const type = (v === "folgetermin" || v === "folge termin" || v === "followup") ? "followup" : "initial";
          $("sessionType").value = type;
          persist();
          showToast(type === "initial" ? "Sitzung: Erstbefund" : "Sitzung: Folgetermin");
          setStatus(`Sitzungstyp gesetzt: <b>${type === "initial" ? "Erstbefund" : "Folgetermin"}</b>`);
          continue;
        }

        // Date
        // ‚ÄúDatum heute/gestern/morgen‚Äù
        const mDate = t.match(/^datum\s+(heute|gestern|morgen)\b/);
        if(mDate){
          const v = mDate[1];
          $("sessionDate").value = v === "heute" ? todayISO() : (v === "gestern" ? shiftISO(-1) : shiftISO(1));
          persist();
          showToast(`Datum: ${$("sessionDate").value}`);
          setStatus(`Datum gesetzt: <b>${$("sessionDate").value}</b>`);
          continue;
        }

        // Actions
        if(t === "stop" || t === "stopp" || t === "stop listening" || t === "stopp listening"){
          stopListening();
          continue;
        }
        if(t === "leeren" || t === "feld leeren"){
          clearActiveField();
          continue;
        }
        if(t === "alles leeren" || t === "reset"){
          clearAll();
          continue;
        }
        if(t === "pdf" || t === "export pdf" || t === "pdf exportieren"){
          exportPdf();
          continue;
        }
        if(t === "speichern" || t === "save" || t === "an theorg senden" || t === "senden"){
          sendToTHEORG();
          continue;
        }
        if(t === "kopieren" || t === "copy"){
          copyActive();
          continue;
        }

        // ---------- DICTATION (nur wenn Feld offen) ----------
        if(!activeFieldOpen){
          if(res.isFinal){
            setStatus(`Ich h√∂re, aber kein Feld ist offen. Sag <span class="mono">‚Äû√ñffne ‚Ä¶‚Äú</span>.`);
          }
          continue;
        }

        if(res.isFinal){
          const cur = (textareas[activeTab].value || "").trim();
          const next = (cur ? (cur + " ") : "") + transcript.trim();
          textareas[activeTab].value = next;
          textareas[activeTab].scrollTop = textareas[activeTab].scrollHeight;
          updateFilledTabs();
          persist();
        }
      }
    };

    try { rec.start(); } catch(e){
      setStatus(`‚ö†Ô∏è Konnte Listening nicht starten: ${e && e.message ? e.message : "unbekannt"}`);
      showToast("Start fehlgeschlagen");
    }
  }

  function stopListening(){
    if(rec){
      try{ rec.onresult = null; } catch(e){}
      try{ rec.stop(); } catch(e){}
    }
    rec = null;
    setMic(false);
    setStatus(`Listening OFF.`);
    showToast("Listening OFF");
  }

  // ---------- ACTIONS ----------
  async function copyActive(){
    const val = (textareas[activeTab].value || "").trim();
    if(!val){ showToast("Feld ist leer"); return; }
    try{
      await navigator.clipboard.writeText(val);
      showToast(`${tabLabel(activeTab)} kopiert`);
    } catch(e){
      textareas[activeTab].focus();
      textareas[activeTab].select();
      document.execCommand("copy");
      showToast(`${tabLabel(activeTab)} kopiert`);
    }
  }

  function buildPayload(){
    const patientId = $("patientSelect").value;
    const patient = patients.find(p => p.id === patientId) || null;

    return {
      integration: "THEORG",
      patient: patient ? { id: patient.id, name: patient.name, year: patient.year } : null,
      session: {
        type: $("sessionType").value,
        date: $("sessionDate").value || null,
        fields: {
          anamnese: textareas.anamnese.value.trim(),
          befund: textareas.befund.value.trim(),
          diagnose: textareas.diagnose.value.trim(),
          therapieplan: textareas.therapieplan.value.trim(),
          verlauf: textareas.verlauf.value.trim(),
          epikrise: textareas.epikrise.value.trim(),
          notizen: textareas.notizen.value.trim(),
        }
      },
      createdAt: new Date().toISOString()
    };
  }

  function sendToTHEORG(){
    const payload = buildPayload();
    if(!payload.patient){
      showToast("Bitte Patient ausw√§hlen");
      setStatus(`Bitte zuerst einen Patienten ausw√§hlen.`);
      return;
    }
    console.log("THEORG payload (mock):", payload);
    setStatus(`‚úÖ Payload erstellt (Mock). In echter Integration w√ºrde jetzt an THEORG gesendet werden.`);
    showToast("An THEORG gesendet (Mock)");
  }

  function exportPdf(){
    const payload = buildPayload();
    const now = new Date().toLocaleString("de-DE");
    const safe = (s) => (s||"")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/\n/g,"<br/>");

    const patientLine = payload.patient
      ? `${payload.patient.name} (${payload.patient.year}) ¬∑ ${payload.patient.id}`
      : "‚Äî";

    const blocks = [
      ["Anamnese", payload.session.fields.anamnese],
      ["Befund", payload.session.fields.befund],
      ["Diagnose", payload.session.fields.diagnose],
      ["Therapieplan", payload.session.fields.therapieplan],
      ["Verlauf", payload.session.fields.verlauf],
      ["Epikrise", payload.session.fields.epikrise],
      ["Notizen", payload.session.fields.notizen],
    ].map(([h,v]) => `
      <h2>${h}</h2>
      <div class="box">${safe(v && v.trim() ? v : "‚Äî")}</div>
    `).join("");

    const w = window.open("", "_blank");
    const html = `
      <!doctype html>
      <html><head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width,initial-scale=1"/>
        <title>PhysioNote ‚Äì PDF</title>
        <style>
          body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;padding:26px;color:#111827}
          h1{margin:0;font-size:20px;color:#0f172a}
          .meta{margin-top:6px;color:#6b7280;font-size:12px}
          h2{font-size:14px;margin:18px 0 8px 0;color:#0f172a}
          .box{border:1px solid #d1d5db;border-radius:12px;padding:12px;background:#f9fafb;line-height:1.55}
          .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
          .k{color:#6b7280;font-size:12px}
          .v{font-size:12px}
          @media print {.meta{margin-bottom:12px}}
          @media (max-width:700px){.grid{grid-template-columns:1fr}}
        </style>
      </head>
      <body>
        <h1>Dokumentation</h1>
        <div class="meta">PhysioNote ¬∑ ${now}</div>

        <div class="grid">
          <div><div class="k">Patient</div><div class="v">${safe(patientLine)}</div></div>
          <div><div class="k">Sitzung</div><div class="v">${safe(payload.session.type)} ¬∑ ${safe(payload.session.date || "‚Äî")}</div></div>
        </div>

        ${blocks}
        <script>window.onload = () => window.print();<\/script>
      </body></html>
    `;
    w.document.open();
    w.document.write(html);
    w.document.close();

    showToast("PDF ge√∂ffnet");
  }

  // ---------- WIRE UI ----------
  $("btnStart").addEventListener("click", startListening);
  $("btnStop").addEventListener("click", stopListening);
  $("btnCloseField").addEventListener("click", closeField);
  $("btnCopy").addEventListener("click", copyActive);
  $("btnPdf").addEventListener("click", exportPdf);
  $("btnClear").addEventListener("click", clearAll);
  $("btnFieldClear").addEventListener("click", clearActiveField);
  $("btnSave").addEventListener("click", sendToTHEORG);

  $("patientSelect").addEventListener("change", updatePatientMeta);
  $("sessionType").addEventListener("change", persist);
  $("sessionDate").addEventListener("change", persist);

  // keyboard shortcuts
  document.addEventListener("keydown", (e)=>{
    if(e.code === "Space"){
      e.preventDefault();
      if(listening) stopListening(); else startListening();
    }
    if(e.code === "Escape"){
      e.preventDefault();
      closeField();
    }
  });

  // ---------- INIT ----------
  renderPatients();
  $("sessionDate").value = todayISO();
  setActiveTab("anamnese");
  closeField();
  restore();

  if(!supportsSpeech()){
    setStatus(`‚ö†Ô∏è SpeechRecognition nicht verf√ºgbar. Bitte Chrome/Edge verwenden.`);
    showToast("SpeechRecognition nicht verf√ºgbar");
  } else {
    setStatus(`Bereit. Starte Listening und steuere Patient/Sitzung/Tabs per Sprache.`);
  }
</script>
</body>
</html>