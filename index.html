<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhysioNote</title>
  <style>
    :root{
      --bg:#f5f5f7;
      --card:#ffffff;
      --border:#d1d5db;
      --accent:#06b6d4;
      --accent-soft:rgba(6,182,212,.10);
      --dark:#0f172a;
      --text:#111827;
      --muted:#6b7280;
      --danger:#b91c1c;
      --shadow:0 10px 30px rgba(15,23,42,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .shell{max-width:1100px;margin:0 auto;padding:20px 14px 34px}
    .card{border-radius:var(--radius);border:1px solid var(--border);background:var(--card);box-shadow:var(--shadow);padding:16px 18px}
    .card + .card{margin-top:14px}

    .header{position:relative;overflow:hidden}
    .header::before{
      content:"";position:absolute;inset:-40%;
      background:
        radial-gradient(circle at top left, rgba(6,182,212,.20), transparent 55%),
        radial-gradient(circle at top right, rgba(15,23,42,.08), transparent 60%);
      pointer-events:none;
    }
    .headerInner{position:relative;z-index:1;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap}
    .title{font-size:28px;font-weight:850;letter-spacing:-.03em;color:var(--dark);line-height:1.1}
    .sub{font-size:13px;color:var(--muted);max-width:780px;line-height:1.35;margin-top:6px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border-radius:999px;padding:7px 12px;
      border:1px solid var(--border);background:#f9fafb;color:var(--muted);
      font-size:12px;user-select:none
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(148,163,184,.8)}
    .dot.on{background:#22c55e;box-shadow:0 0 0 4px rgba(34,197,94,.12)}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{
      border:none;cursor:pointer;border-radius:999px;padding:9px 14px;
      font-size:12px;font-weight:680;display:inline-flex;align-items:center;gap:8px;
      transition:transform .05s ease, filter .12s ease, background .12s ease;
      user-select:none;white-space:nowrap
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:var(--accent);color:#ecfeff;box-shadow:0 8px 24px rgba(6,182,212,.33)}
    .btn.ghost{background:#f9fafb;border:1px solid var(--border);color:var(--dark)}
    .btn.danger{background:#fee2e2;border:1px solid #fecaca;color:var(--danger)}
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost:hover{background:#fff}

    .status{
      margin-top:10px;border-radius:14px;padding:10px 12px;
      border:1px solid rgba(15,23,42,.10);background:#f9fafb;
      font-size:12px;color:var(--muted);line-height:1.35
    }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .kbd{font-size:11px;padding:2px 6px;border-radius:6px;border:1px solid rgba(15,23,42,.15);background:#fff;color:#0f172a}

    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
    .tab{
      border-radius:999px;padding:7px 12px;font-size:12px;cursor:pointer;
      border:1px solid var(--border);background:#f9fafb;color:var(--muted);
      user-select:none
    }
    .tab.active{
      background:var(--accent);color:#ecfeff;border-color:var(--accent);
      box-shadow:0 6px 18px rgba(6,182,212,.28)
    }

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{
      width:100%;border-radius:14px;border:1px solid var(--border);
      background:#f9fafb;color:var(--text);font-size:14px;padding:12px 12px;
      outline:none;line-height:1.55;min-height:280px;resize:vertical
    }
    textarea:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(6,182,212,.18);background:#fff}

    .hint{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media (min-width: 980px){
      .grid{grid-template-columns:1fr 1fr}
      textarea{min-height:320px}
    }
  </style>
</head>
<body>
  <div class="shell">

    <div class="card header">
      <div class="headerInner">
        <div>
          <div class="title">PhysioNote</div>
          <div class="sub">
            Voice-first Dokumentation. <b>Start Listening</b> ‚Üí dann per Sprache <b>‚Äû√ñffne Anamnese‚Äú</b> (oder Befund etc.) ‚Üí sprechen ‚Üí <b>‚ÄûSchlie√üe Feld‚Äú</b> / <b>Stop Listening</b>.
          </div>
        </div>

        <div class="pill" title="Mikrofonstatus">
          <span class="dot" id="micDot"></span>
          <span id="micText">Mic: OFF</span>
        </div>
      </div>

      <div class="status" id="status">
        Status: Bereit. Mic ist aus. Starte Listening, dann sag z.B. <span class="mono">‚Äû√ñffne Anamnese‚Äú</span>.
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="btnRow">
          <button class="btn primary" id="btnStart">üéôÔ∏è Start Listening</button>
          <button class="btn danger" id="btnStop">‚èπÔ∏è Stop Listening</button>
          <button class="btn ghost" id="btnCloseField">‚úñÔ∏è Schlie√üe Feld</button>
        </div>
        <div class="btnRow">
          <button class="btn ghost" id="btnCopy">üìã Kopieren (Aktives Feld)</button>
          <button class="btn ghost" id="btnPdf">üìÑ Export PDF</button>
          <button class="btn ghost" id="btnClearAll">üßº Alles leeren</button>
        </div>
      </div>

      <div class="hint">
        Sprachbefehle (Beispiele):
        <span class="kbd">√ñffne Anamnese</span>
        <span class="kbd">√ñffne Befund</span>
        <span class="kbd">√ñffne Diagnose</span>
        <span class="kbd">√ñffne Therapieplan</span>
        <span class="kbd">√ñffne Verlauf</span>
        <span class="kbd">√ñffne Epikrise</span>
        <span class="kbd">√ñffne Notizen</span>
        ¬∑
        <span class="kbd">Schlie√üe Feld</span>
        <span class="kbd">Leeren</span>
        <span class="kbd">Alles leeren</span>
        <span class="kbd">Export PDF</span>
        <span class="kbd">Stop Listening</span>
      </div>
    </div>

    <div class="card">
      <div class="tabs" id="tabs">
        <div class="tab active" data-target="anamnesis">Anamnese</div>
        <div class="tab" data-target="befund">Befund</div>
        <div class="tab" data-target="diagnose">Diagnose</div>
        <div class="tab" data-target="therapieplan">Therapieplan</div>
        <div class="tab" data-target="verlauf">Verlauf</div>
        <div class="tab" data-target="epikrise">Epikrise</div>
        <div class="tab" data-target="notizen">Notizen</div>
      </div>

      <div class="grid">
        <div>
          <label>Anamnese</label>
          <textarea id="anamnesis" placeholder="Sage: ‚Äû√ñffne Anamnese‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
        <div>
          <label>Befund</label>
          <textarea id="befund" placeholder="Sage: ‚Äû√ñffne Befund‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
        <div>
          <label>Diagnose</label>
          <textarea id="diagnose" placeholder="Sage: ‚Äû√ñffne Diagnose‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
        <div>
          <label>Therapieplan</label>
          <textarea id="therapieplan" placeholder="Sage: ‚Äû√ñffne Therapieplan‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
        <div>
          <label>Verlauf</label>
          <textarea id="verlauf" placeholder="Sage: ‚Äû√ñffne Verlauf‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
        <div>
          <label>Epikrise</label>
          <textarea id="epikrise" placeholder="Sage: ‚Äû√ñffne Epikrise‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
        <div>
          <label>Notizen</label>
          <textarea id="notizen" placeholder="Sage: ‚Äû√ñffne Notizen‚Äú ‚Äì dann wird hier transkribiert."></textarea>
        </div>
      </div>

      <div class="hint">
        <b>Wichtig:</b> Es wird nur transkribiert, wenn ein Feld aktiv ist (√ºber ‚Äû√ñffne ‚Ä¶‚Äú). Sonst wird nichts geschrieben.
      </div>
    </div>

  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const ui = {
      btnStart: $("btnStart"),
      btnStop: $("btnStop"),
      btnCloseField: $("btnCloseField"),
      btnCopy: $("btnCopy"),
      btnPdf: $("btnPdf"),
      btnClearAll: $("btnClearAll"),
      micDot: $("micDot"),
      micText: $("micText"),
      status: $("status"),
      tabs: $("tabs"),
      fields: {
        anamnesis: $("anamnesis"),
        befund: $("befund"),
        diagnose: $("diagnose"),
        therapieplan: $("therapieplan"),
        verlauf: $("verlauf"),
        epikrise: $("epikrise"),
        notizen: $("notizen"),
      }
    };

    let rec = null;
    let listening = false;

    // Active field is null until user says "√ñffne ..."
    let activeKey = null; // one of keys in ui.fields
    let bufferFinal = { anamnesis:"", befund:"", diagnose:"", therapieplan:"", verlauf:"", epikrise:"", notizen:"" };
    let bufferInterim = "";

    function setStatus(html){
      ui.status.innerHTML = "Status: " + html;
    }

    function setMic(on){
      listening = on;
      if(on){
        ui.micDot.classList.add("on");
        ui.micText.textContent = "Mic: ON";
      } else {
        ui.micDot.classList.remove("on");
        ui.micText.textContent = "Mic: OFF";
      }
    }

    function normalize(s){
      return (s||"")
        .toLowerCase()
        .replace(/[√§]/g,"ae").replace(/[√∂]/g,"oe").replace(/[√º]/g,"ue").replace(/√ü/g,"ss")
        .replace(/[^\p{L}\p{N}\s]/gu," ")
        .replace(/\s+/g," ")
        .trim();
    }

    function setActiveField(key){
      activeKey = key;
      // highlight tab UI
      [...ui.tabs.querySelectorAll(".tab")].forEach(t => {
        t.classList.toggle("active", t.dataset.target === key);
      });
      // focus field
      const ta = ui.fields[key];
      if(ta){ ta.focus(); }
      setStatus(`<b>Aktives Feld:</b> ${labelForKey(key)} ¬∑ Sprich jetzt, um zu transkribieren.`);
    }

    function closeField(){
      activeKey = null;
      [...ui.tabs.querySelectorAll(".tab")].forEach(t => t.classList.remove("active"));
      setStatus(`Feld geschlossen. Nichts wird transkribiert, bis du <span class="mono">‚Äû√ñffne ‚Ä¶‚Äú</span> sagst.`);
    }

    function labelForKey(key){
      const map = {
        anamnesis: "Anamnese",
        befund: "Befund",
        diagnose: "Diagnose",
        therapieplan: "Therapieplan",
        verlauf: "Verlauf",
        epikrise: "Epikrise",
        notizen: "Notizen"
      };
      return map[key] || key;
    }

    function renderActive(){
      if(!activeKey) return;
      const final = bufferFinal[activeKey] || "";
      const text = (final + (bufferInterim ? (" " + bufferInterim) : "")).trim();
      ui.fields[activeKey].value = text;
      ui.fields[activeKey].scrollTop = ui.fields[activeKey].scrollHeight;
    }

    function commitFinal(text){
      if(!activeKey) return; // trust: never write without an active field
      if(!text) return;
      const cur = (bufferFinal[activeKey] || "").trim();
      bufferFinal[activeKey] = (cur ? (cur + " ") : "") + text.trim();
      bufferInterim = "";
      renderActive();
    }

    // -------------------------
    // COMMAND PARSER
    // -------------------------
    // Commands are only recognized when listening is ON.
    // We strip commands out so they do NOT end up in the text areas.
    function handleCommandOrDictation(rawTranscript, isFinal){
      const t = normalize(rawTranscript);

      // Commands (German)
      // "oeffne X"
      const openMatch = t.match(/^oeffne\s+(anamnese|befund|diagnose|therapieplan|therapie plan|verlauf|epikrise|notizen|notiz)\b/);
      if(openMatch){
        const target = openMatch[1];
        const key =
          target === "anamnese" ? "anamnesis" :
          target === "befund" ? "befund" :
          target === "diagnose" ? "diagnose" :
          (target === "therapieplan" || target === "therapie plan") ? "therapieplan" :
          target === "verlauf" ? "verlauf" :
          target === "epikrise" ? "epikrise" :
          (target === "notizen" || target === "notiz") ? "notizen" :
          null;
        if(key){
          setActiveField(key);
          // Do NOT transcribe the command
          return { consumed:true };
        }
      }

      if(t === "schliesse feld" || t === "schliesse" || t === "feld schliessen" || t === "schlie√üe feld"){
        closeField();
        return { consumed:true };
      }

      if(t === "stop listening" || t === "stopp listening" || t === "stop" || t === "stopp"){
        stopListening();
        return { consumed:true };
      }

      if(t === "leeren" || t === "feld leeren"){
        if(activeKey){
          bufferFinal[activeKey] = "";
          bufferInterim = "";
          ui.fields[activeKey].value = "";
          setStatus(`<b>${labelForKey(activeKey)}</b> geleert.`);
        } else {
          setStatus(`Kein aktives Feld zum Leeren. Sag <span class="mono">‚Äû√ñffne ‚Ä¶‚Äú</span> zuerst.`);
        }
        return { consumed:true };
      }

      if(t === "alles leeren" || t === "reset"){
        Object.keys(bufferFinal).forEach(k => bufferFinal[k] = "");
        bufferInterim = "";
        Object.values(ui.fields).forEach(ta => ta.value = "");
        closeField();
        setStatus(`Alles geleert.`);
        return { consumed:true };
      }

      if(t === "export pdf" || t === "pdf exportieren" || t === "exportiere pdf"){
        exportPdf();
        return { consumed:true };
      }

      if(t === "kopieren" || t === "copy"){
        copyActive();
        return { consumed:true };
      }

      // If no command: treat as dictation, but ONLY if a field is active.
      if(!activeKey){
        // trust: never write without explicit "√ñffne ..."
        if(isFinal){
          setStatus(`Ich h√∂re, aber kein Feld ist offen. Sag z.B. <span class="mono">‚Äû√ñffne Anamnese‚Äú</span>.`);
        }
        return { consumed:true }; // consume to avoid accidental writing anywhere
      }

      // Dictation path
      if(isFinal){
        commitFinal(rawTranscript);
      } else {
        bufferInterim = rawTranscript;
        renderActive();
      }
      return { consumed:true };
    }

    // -------------------------
    // LISTENING
    // -------------------------
    function supportsSpeech(){ return !!SpeechRecognition; }

    function startListening(){
      if(!supportsSpeech()){
        setStatus(`SpeechRecognition nicht verf√ºgbar. Bitte Chrome/Edge verwenden.`);
        return;
      }
      if(listening) return;

      rec = new SpeechRecognition();
      rec.lang = "de-DE";
      rec.interimResults = true;
      rec.continuous = true;

      rec.onstart = () => {
        setMic(true);
        setStatus(`Listening ON. Sag <span class="mono">‚Äû√ñffne Anamnese‚Äú</span> um zu starten.`);
      };

      rec.onerror = (e) => {
        setMic(false);
        setStatus(`‚ö†Ô∏è Mikrofon-Fehler: <span class="mono">${(e && e.error) ? e.error : "unbekannt"}</span>`);
      };

      rec.onend = () => {
        // If user presses stop, this will fire. We keep strict OFF.
        setMic(false);
        bufferInterim = "";
        if(activeKey) renderActive();
        if(!listening) {
          // already set off
        }
        setStatus(`Listening OFF. (Nichts wird geh√∂rt.)`);
      };

      rec.onresult = (event) => {
        // Process all results; handle commands or dictation
        for(let i = event.resultIndex; i < event.results.length; i++){
          const res = event.results[i];
          const transcript = (res[0] && res[0].transcript ? res[0].transcript : "").trim();
          if(!transcript) continue;
          handleCommandOrDictation(transcript, res.isFinal);
        }
      };

      try{ rec.start(); } catch(err){
        setStatus(`‚ö†Ô∏è Konnte Listening nicht starten: ${err && err.message ? err.message : "unbekannt"}`);
      }
    }

    function stopListening(){
      // immediate trust: stop everything
      if(rec){
        try{ rec.onresult = null; } catch(e){}
        try{ rec.stop(); } catch(e){}
      }
      rec = null;
      setMic(false);
      bufferInterim = "";
      if(activeKey) renderActive();
      setStatus(`Listening OFF. (Nichts wird geh√∂rt.)`);
    }

    // -------------------------
    // UI Buttons
    // -------------------------
    ui.btnStart.addEventListener("click", startListening);
    ui.btnStop.addEventListener("click", stopListening);
    ui.btnCloseField.addEventListener("click", closeField);
    ui.btnClearAll.addEventListener("click", () => {
      Object.keys(bufferFinal).forEach(k => bufferFinal[k] = "");
      bufferInterim = "";
      Object.values(ui.fields).forEach(ta => ta.value = "");
      closeField();
      setStatus(`Alles geleert.`);
    });

    // Clicking tabs manually (allowed) ‚Äì also sets active field
    ui.tabs.addEventListener("click", (e) => {
      const t = e.target.closest(".tab");
      if(!t) return;
      setActiveField(t.dataset.target);
    });

    // Copy active field only
    async function copyActive(){
      if(!activeKey){
        setStatus(`Kein aktives Feld. Sag <span class="mono">‚Äû√ñffne ‚Ä¶‚Äú</span> oder klicke einen Tab.`);
        return;
      }
      const val = (ui.fields[activeKey].value || "").trim();
      if(!val){ setStatus(`Aktives Feld ist leer.`); return; }
      try{
        await navigator.clipboard.writeText(val);
        setStatus(`üìã ${labelForKey(activeKey)} kopiert.`);
      } catch(e){
        ui.fields[activeKey].focus();
        ui.fields[activeKey].select();
        document.execCommand("copy");
        window.getSelection().removeAllRanges();
        setStatus(`üìã ${labelForKey(activeKey)} kopiert (Fallback).`);
      }
    }
    ui.btnCopy.addEventListener("click", copyActive);

    // Export PDF (print) of all sections
    function exportPdf(){
      const now = new Date().toLocaleString("de-DE");
      const safe = (s) =>
        (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>");

      const sections = [
        ["Anamnese", ui.fields.anamnesis.value],
        ["Befund", ui.fields.befund.value],
        ["Diagnose", ui.fields.diagnose.value],
        ["Therapieplan", ui.fields.therapieplan.value],
        ["Verlauf", ui.fields.verlauf.value],
        ["Epikrise", ui.fields.epikrise.value],
        ["Notizen", ui.fields.notizen.value],
      ];

      const blocks = sections.map(([h,v]) => `
        <h2>${h}</h2>
        <div class="box">${safe((v||"").trim() || "‚Äî")}</div>
      `).join("");

      const w = window.open("", "_blank");
      const html = `
        <!doctype html>
        <html>
        <head>
          <meta charset="utf-8"/>
          <meta name="viewport" content="width=device-width,initial-scale=1"/>
          <title>PhysioNote ‚Äì Dokumentation</title>
          <style>
            body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding:26px;color:#111827}
            h1{margin:0 0 6px 0;font-size:20px}
            .meta{color:#6b7280;font-size:12px;margin-bottom:18px}
            h2{font-size:14px;margin:18px 0 8px 0;color:#0f172a}
            .box{border:1px solid #d1d5db;border-radius:12px;padding:12px;background:#f9fafb;line-height:1.55}
            @media print{ .meta{margin-bottom:12px} }
          </style>
        </head>
        <body>
          <h1>Dokumentation</h1>
          <div class="meta">PhysioNote ¬∑ ${now}</div>
          ${blocks}
          <script>window.onload = () => window.print();<\/script>
        </body>
        </html>
      `;
      w.document.open();
      w.document.write(html);
      w.document.close();
      setStatus(`üìÑ Export ge√∂ffnet. Im Dialog ‚ÄûAls PDF speichern‚Äú w√§hlen.`);
    }
    ui.btnPdf.addEventListener("click", exportPdf);

    // Initial status
    setMic(false);
    closeField();
    if(!supportsSpeech()){
      setStatus(`‚ö†Ô∏è SpeechRecognition nicht verf√ºgbar. Bitte Chrome/Edge verwenden.`);
    } else {
      setStatus(`Bereit. Starte Listening, dann sag <span class="mono">‚Äû√ñffne Anamnese‚Äú</span>.`);
    }
  </script>
</body>
</html>